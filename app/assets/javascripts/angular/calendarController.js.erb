app.controller('CalendarCtrl',
  function ($scope, $modal, workitemService) {

    // page is now ready, initialize the calendar...

    $(document).ready(function() {
		
		$('#calendar').fullCalendar({
			header: {
				left: 'prev,next today',
				center: 'title',
				right: ''
			},
			buttonText: {
				today: 'Today'
			},
			defaultDate: new Date(),
			editable: true,
			eventLimit: true,
			timeFormat: ''
		});

		workitemService.getWorkItems().then(function(workitems) {
			workitemService.getWorkEstimate().then(function(workEstimate) {
				console.log(workEstimate);
			});
			workitems = workitems.sort(function(a, b) {
				return new Date(a.due_date) - new Date(b.due_date);
			});
			workitems.forEach(function(workitem) {

				var task = {
					name: workitem.content,
					time: workitem.minutes_needed/ 60,
					completedTime: workitem.minutes_completed / 60,
					date: new Date(workitem.due_date),
					id: workitem.id
				};
				var calTask = { id: task.id, title: task.name, start: task.date, end: task.date};
				$('#calendar').fullCalendar('renderEvent', calTask, true);

				$scope.tasks.push(task);
			});
		});
		
	});

	$scope.tasks = [];

	$scope.totalTimeObj = {
		totaltime: 0
	};

	$scope.createTask = function() {
		var modalInstance = $modal.open({
	      templateUrl: 'taskModal.html',
	      controller: 'TaskModalCtrl',
	      size: 'md',
	      resolve: {
	      	tasks: function() {
	      		return $scope.tasks;
	      	},
	      	task: function() {
	      		return {
	      			name: '',
	      			date: '',
	      			time: ''
	      		}
	      	},
	      	edit: function() {
	      		return false;
	      	},
	      	workitemService: function() {
	      		return workitemService;
	      	},
	      	totalTimeObj: function() {
	      		return $scope.totalTimeObj;
	      	}
	      }
	    });
	};
	$scope.inspectTask = function(currentTask) {
		var modalInstance = $modal.open({
	      templateUrl: 'taskModal.html',
	      controller: 'TaskModalCtrl',
	      size: 'md',
	      resolve: {
	      	tasks: function() {
	      		return $scope.tasks;
	      	},
	      	task: function() {
	      		return currentTask;
	      	},
	      	edit: function() {
	      		return true;
	      	},
	      	workitemService: function() {
	      		return workitemService;
	      	}
	      }
	    });
	}

  });